!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r(require("fs"),require("path"),require("zokrates-js"),require("seedrandom"),require("ethers"),require("isomorphic-unfetch"),require("web3.storage"),require("@ipld/car/reader"),require("stream"),require("multiformats/block"),require("multiformats/hashes/sha2"),require("multiformats/codecs/raw"),require("@ipld/dag-json"),require("@ipld/dag-cbor"),require("@ipld/car/writer"),require("merkletreejs"),require("keccak256"),require("axios")):"function"==typeof define&&define.amd?define(["fs","path","zokrates-js","seedrandom","ethers","isomorphic-unfetch","web3.storage","@ipld/car/reader","stream","multiformats/block","multiformats/hashes/sha2","multiformats/codecs/raw","@ipld/dag-json","@ipld/dag-cbor","@ipld/car/writer","merkletreejs","keccak256","axios"],r):(e||self).zkTraceSdk=r(e.fs,e.path,e.zokratesJs,e.seedrandom,e.ethers,e.isomorphicUnfetch,e.web3_storage,e.reader,e.stream,e.Block,e.sha2,e.raw,e.dagJSON,e.dagCBOR,e.writer,e.merkletreejs,e.keccak256,e.axios)}(this,function(e,r,t,o,n,i,s,c,u,a,l,f,h,d,m,v,P,g){function y(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function p(e){if(e&&e.__esModule)return e;var r=Object.create(null);return e&&Object.keys(e).forEach(function(t){if("default"!==t){var o=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,o.get?o:{enumerable:!0,get:function(){return e[t]}})}}),r.default=e,r}var k=/*#__PURE__*/p(e),b=/*#__PURE__*/y(o),j=/*#__PURE__*/y(i),w=/*#__PURE__*/p(a),S=/*#__PURE__*/p(f),C=/*#__PURE__*/p(h),O=/*#__PURE__*/p(d),x=/*#__PURE__*/y(P),T=/*#__PURE__*/y(g);class ${constructor(e){this.nodeEndpoint=void 0,this.web3storageApiKey=void 0,this.factoryAddress=void 0,this.apikey=void 0,this.baseUrl=void 0,this.nodeEndpoint=e.nodeEndpoint||"https://api.hyperspace.node.glif.io/rpc/v1",this.baseUrl=e.baseUri||"http://localhost:5000/",this.apikey=e.apikey,this.web3storageApiKey=e.web3storageApiKey,this.factoryAddress=e.factoryAddress||"l3j4kjenwone"}invoke(e,r){const t={...r,headers:{"content-type":"application/json",apiKey:this.apikey}};return j.default(`${this.baseUrl}${e}`,t).then(e=>{if(200===e.status)return e.json();throw new Error("call failed")})}getWeb3StorageKey(){return this.web3storageApiKey}getProvider(){try{return Promise.resolve(new n.ethers.providers.JsonRpcProvider(this.nodeEndpoint))}catch(e){return Promise.reject(e)}}getFactoryAddress(){return this.factoryAddress}}function A(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}const q="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function B(e,r,t){if(!e.s){if(t instanceof I){if(!t.s)return void(t.o=B.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(B.bind(null,e,r),B.bind(null,e,2));e.s=r,e.v=t;const o=e.o;o&&o(e)}}const I=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(r,t){const o=new e,n=this.s;if(n){const e=1&n?r:t;if(e){try{B(o,1,e(this.v))}catch(e){B(o,2,e)}return o}return this}return this.o=function(e){try{const n=e.v;1&e.s?B(o,1,r?r(n):n):t?B(o,1,t(n)):B(o,2,n)}catch(e){B(o,2,e)}},o},e}();function N(e){return e instanceof I&&1&e.s}function E(e,r,t){if("function"==typeof e[q]){var o,n,i,s=e[q]();if(function e(c){try{for(;!((o=s.next()).done||t&&t());)if((c=r(o.value))&&c.then){if(!N(c))return void c.then(e,i||(i=B.bind(null,n=new I,2)));c=c.v}n?B(n,1,c):n=c}catch(e){B(n||(n=new I),2,e)}}(),s.return){var c=function(e){try{o.done||s.return()}catch(e){}return e};if(n&&n.then)return n.then(c,function(e){throw c(e)});c()}return n}if(!("length"in e))throw new TypeError("Object is not iterable");for(var u=[],a=0;a<e.length;a++)u.push(e[a]);return function(e,r,t){var o,n,i=-1;return function s(c){try{for(;++i<e.length&&(!t||!t());)if((c=r(i))&&c.then){if(!N(c))return void c.then(s,n||(n=B.bind(null,o=new I,2)));c=c.v}o?B(o,1,c):o=c}catch(e){B(o||(o=new I),2,e)}}(),o}(u,function(e){return r(u[e])},t)}const F="undefined"!=typeof Symbol?Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")):"@@asyncIterator";class D extends ${constructor(){super(...arguments);const e=this,r=this,t=this,o=this,n=this,i=this,a=this,f=this;this.initilizeWeb3Storage=function(){try{const e=new s.Web3Storage({token:f.getWeb3StorageKey()});return Promise.resolve(e)}catch(e){return Promise.reject(e)}},this.uploadCarToIPFS=function(e){try{return Promise.resolve(A(function(){return Promise.resolve(a.initilizeWeb3Storage()).then(function(r){const t=k.createReadStream(`./cars/${e}.car`);return Promise.resolve(c.CarReader.fromIterable(t)).then(function(t){return Promise.resolve(r.putCar(t,{name:`${e}.car`,decoders:[O]})).then(function(e){return console.log(`IPFS CID: ${e}`),e})})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.readData=function(e){try{let r;return Promise.resolve(A(function(){return Promise.resolve(T.default.get(`https://ipfs.io/api/v0/dag/get/${e}`).then(e=>{r=e.data.data}).catch(e=>{console.log(e)})).then(function(){return r})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.utf8Encoder=new TextEncoder,this.utf8Decoder=new TextDecoder,this.createBlock=function(e){try{const r=[];return Promise.resolve(A(function(){return Promise.resolve(w.encode({value:{data:e},hasher:l.sha256,codec:O})).then(function(e){return r.push(e),console.log(r),console.log(e.cid),{blocks:r,roots:[e.cid]}})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.write=function(e,r,t){try{return Promise.resolve(A(function(){k.existsSync("./cars")||k.mkdirSync("./cars");const{writer:o,out:n}=m.CarWriter.create(e);u.Readable.from(n).pipe(k.createWriteStream(`cars/${t}.car`));const i=E(r,function(e){return Promise.resolve(o.put(e)).then(function(){return Promise.resolve(o.close()).then(function(){})})});return i&&i.then?i.then(function(){return n}):n},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.read=function(e){try{const r={[S.code]:S,[C.code]:C,[O.code]:O},t={[l.sha256.code]:l.sha256};return Promise.resolve(A(function(){const o=k.createReadStream(`./cars/${e}.car`);return Promise.resolve(c.CarReader.fromIterable(o)).then(function(e){return Promise.resolve(e.getRoots()).then(function(o){function n(){return{blockCid:u,data:c}}const s=[];let c,u;const a=function(e,r,t){if("function"==typeof e[F]){var o=new I,n=e[F]();return n.next().then(s).then(void 0,c),o;function i(e){if(t&&t())return B(o,1,n.return?n.return().then(function(){return e}):e);n.next().then(s).then(void 0,c)}function s(e){e.done?B(o,1):Promise.resolve(r(e.value)).then(i).then(void 0,c)}function c(e){B(o,2,n.return?n.return().then(function(){return e}):e)}}return Promise.resolve(E(e,function(e){return Promise.resolve(e).then(r)},t))}(e.blocks(),function(e){let{cid:o,bytes:n}=e;return Promise.resolve(w.create({cid:o,bytes:n,codec:r[o.code],hasher:t[o.multihash.code]})).then(function(e){s.push(e);const r=e.value instanceof Uint8Array?i.utf8Decoder.decode(e.value):e.value,t=JSON.parse(JSON.stringify(r.data));c=t,u=o.toString(),console.log(`Previous Block CID: ${t.previousBlockCid}, New Block CID: ${o.toString()}`)})});return a&&a.then?a.then(n):n()})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.updatPreviousBlockCid=(e,r)=>{let t=e;return t.previousBlockCid=r,t},this.updateCar1=function(e,r){try{function t(){return console.log(`Car Packed at: cars/${r}.car , CID: ${o}`),o}let o;const i=A(function(){return Promise.resolve(n.read(r)).then(function(t){let{blockCid:i}=t;const s=n.updatPreviousBlockCid(e,i);return Promise.resolve(n.createBlock(s)).then(function(e){let{blocks:t,roots:i}=e;return Promise.resolve(n.write(i,t,r)).then(function(){return Promise.resolve(n.uploadCarToIPFS(r)).then(function(e){o=e})})})})},function(e){console.log(e)});return Promise.resolve(i&&i.then?i.then(t):t())}catch(s){return Promise.reject(s)}},this.writeCar=function(e,r){try{let t;const n=A(function(){return Promise.resolve(o.createBlock(e)).then(function(e){let{blocks:n,roots:i}=e;return Promise.resolve(o.write(i,n,r)).then(function(){return Promise.resolve(o.uploadCarToIPFS(r)).then(function(e){t=e,console.log(`Car Packed at: cars/${r}.car`),k.existsSync(`./cars/${r}.car`)&&k.unlinkSync(`./cars/${r}.car`)})})})},function(e){console.log(e)});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},this.buff2Hex=e=>"0x"+e.toString("hex"),this.getMerkelTree=function(e){try{try{const r=e.map(e=>x.default(e)),o=new v.MerkleTree(r,x.default),n=t.buff2Hex(o.getRoot());return Promise.resolve({tree:o,root:n})}catch(e){console.log(e)}return Promise.resolve()}catch(e){return Promise.reject(e)}},this.getleave=e=>this.buff2Hex(x.default(e)),this.getMerkelProof=function(e,t){try{return Promise.resolve(A(function(){return Promise.resolve(r.getMerkelTree(t)).then(function(t){let{tree:o}=t;return o.getProof(e).map(e=>r.buff2Hex(e.data))})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.createProof=function(r,t){try{return Promise.resolve(A(function(){return Promise.resolve(e.read(t)).then(function(t){let{...o}=t;const n=e.getleave(r);return Promise.resolve(e.getMerkelProof(n,o.data.verifiers)).then(function(e){return console.log(e),e})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}}}readCid(e){try{return Promise.resolve(this.invoke(`storage/readData/${e}`))}catch(e){return Promise.reject(e)}}readCarData(e){try{return Promise.resolve(this.invoke(`storage/createCar/${e}`))}catch(e){return Promise.reject(e)}}createCar(e,r){try{return Promise.resolve(this.invoke(`storage/createCar/${r}`,{method:"POST",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}uploadCar(e){try{return Promise.resolve(this.invoke(`storage/uploadCar/${e}`,{method:"POST"}))}catch(e){return Promise.reject(e)}}updateCar(e,r){try{return Promise.resolve(this.invoke(`storage/createCar/${r}`,{method:"PUT",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}getMerkelProof(e,r){try{return Promise.resolve(this.invoke(`storage/getMerkelProof/${e}/${r}`,{method:"GET"}))}catch(e){return Promise.reject(e)}}}function z(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}class G extends D{constructor(){super(...arguments),this.rootFromPath="../circuit",this.rootToPath="sdk/circuit/root.zok"}randomNumber(e){try{let r=[];for(let t=0;t<4;t++){const t=b.default(e,{entropy:!0});r.push(Math.abs(t.int32()).toString())}return Promise.resolve(r)}catch(e){return Promise.reject(e)}}getNullifier(e){try{const r=b.default(e,{entropy:!1});return Promise.resolve(Math.abs(r.int32()))}catch(e){return Promise.reject(e)}}fileSystemResolver(t,o){try{const n=r.resolve(r.dirname(r.resolve(t)),o),i=e.readFileSync(n).toString();return Promise.resolve(i)}catch(e){return Promise.reject(e)}}getSource(e,r){try{return Promise.resolve(this.fileSystemResolver(e,r))}catch(e){return Promise.reject(e)}}getZokrateProvider(){try{return Promise.resolve(t.initialize())}catch(e){return Promise.reject(e)}}getArtifacts(e){try{return Promise.resolve(this.getZokrateProvider()).then(function(r){return r.compile(e)})}catch(e){return Promise.reject(e)}}getPreImage(e){try{const r=this;return Promise.resolve(z(function(){return Promise.resolve(r.getZokrateProvider()).then(function(t){return Promise.resolve(r.getSource("../circuit","sdk/circuit/preImage.zok")).then(function(o){return Promise.resolve(r.getArtifacts(o)).then(function(r){const{output:o}=t.computeWitness(r,e);return JSON.parse(o)})})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}}generateZkProof(e){try{const r=this;return Promise.resolve(z(function(){return Promise.resolve(r.randomNumber(e)).then(function(e){return Promise.resolve(r.getZokrateProvider()).then(function(t){return Promise.resolve(r.getSource(r.rootFromPath,r.rootToPath)).then(function(o){return Promise.resolve(r.getArtifacts(o)).then(function(o){return Promise.resolve(r.getPreImage(e)).then(function(r){const n=[...e,...r],{witness:i}=t.computeWitness(o,n),s=t.setup(o.program),c=t.generateProof(o.program,i,s.pk),u=s.vk;return{message:"ok",details:{proofBuffer:JSON.stringify(c),verifierKeyBuffer:JSON.stringify(u)}}})})})})})},function(e){return console.log(e),{message:e}}))}catch(e){return Promise.reject(e)}}verifyZkProof(e){try{const r=this,t=e.verifierKeyBuffer,o=JSON.parse(e.proofBuffer),n=JSON.parse(t);return Promise.resolve(z(function(){return Promise.resolve(r.getZokrateProvider()).then(function(e){const r=e.verify(n,o);return r?{message:"Ok",isVerified:r}:{message:"invalid Proof Provided",isVerified:r}})},function(e){return console.log(e),{message:e}}))}catch(e){return Promise.reject(e)}}verifyZkProof1(e){try{return Promise.resolve(this.invoke("zk/verifyProof",{method:"POST",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}}const J=[],R=[];function M(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}class K extends G{createTraceAgreement(e,r){try{const t=this;return Promise.resolve(M(function(){return Promise.resolve(t.getProvider()).then(function(o){const i=new n.ethers.Contract(t.getFactoryAddress(),J,r);let s=[];return Promise.resolve(i.newTraceAgreement(e,{gasLimit:21e3,maxFeePerGas:o.getGasPrice(),maxPriorityFeePerGas:o.getGasPrice()})).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1!=e.status)throw new Error("Creation Failed");for(let r of e.events)s.push(r.event);return Promise.resolve(e.events[0].args.agreementAddress).then(function(r){return Promise.resolve(e.events[0].args.id).then(function(t){return{message:"ok",transactionHash:e.hash,details:{agreementAddress:r,agreementId:t}}})})})})})},function(e){return console.log(e),{message:e}}))}catch(e){return Promise.reject(e)}}initilizeAgreement(e,r,t){try{const o=this;return Promise.resolve(M(function(){return Promise.resolve(o.getProvider()).then(function(i){const s=new n.ethers.Contract(r,R,t);return Promise.resolve(o.getVerifiersDetails(e)).then(function(e){const r=e.details;return Promise.resolve(s.initilize(r.verifiersRoot,r.nullifiers,r.argumentUri,{gasLimit:21e3,maxFeePerGas:i.getGasPrice(),maxPriorityFeePerGas:i.getGasPrice()})).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1!=e.status)throw new Error("initilization failed");return{message:"ok",transactionHash:e.hash}})})})})},function(e){return console.log(e),{message:e}}))}catch(e){return Promise.reject(e)}}getVerifiersDetails(e){try{const r=this;return Promise.resolve(M(function(){const t=n.ethers.utils.defaultAbiCoder;return Promise.resolve(r.getProvider()).then(function(o){return Promise.resolve(r.getMerkelTree(e)).then(function(n){let{root:i}=n;const s=Math.round((new Date).getTime()/1e3).toString();return{message:"ok",details:{verifiersRoot:i,nullifiers:e.forEach(e=>{const n=r.getNullifier(e)*o.getBlockNumber()+s;x.default(t.encode(["uint"],[n]))}),argumentUri:""}}})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}}verifyByOrder(e,r,t,o){try{const i=this;return Promise.resolve(M(function(){return Promise.resolve(i.getProvider()).then(function(i){const s=new n.ethers.Contract(e,R,o);let c=[];return Promise.resolve(s.verifyByOrder(r,t,{gasLimit:21e4,maxFeePerGas:i.getGasPrice(),maxPriorityFeePerGas:i.getGasPrice()})).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1!=e.status)throw new Error("verification failed");for(let r of e.events)c.push(r.event);return Promise.resolve(e.events[0].args.signCount).then(function(r){return Promise.resolve(e.events[0].args.verified).then(function(e){return{message:"ok",details:{verifiedCount:r,verified:e}}})})})})})},function(e){return console.log(e),{message:e}}))}catch(e){return Promise.reject(e)}}}class U extends K{}var W;return W=U,[K].forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(r=>{Object.defineProperty(W.prototype,r,Object.getOwnPropertyDescriptor(e.prototype,r)||Object.create(null))})}),U});
