import*as e from"fs";import{readFileSync as t}from"fs";import{resolve as r,dirname as o}from"path";import{initialize as a}from"zokrates-js";import i from"seedrandom";import{ethers as s}from"ethers";import n from"isomorphic-unfetch";import{Web3Storage as c}from"web3.storage";import{CarReader as l}from"@ipld/car/reader";import{Readable as u}from"stream";import*as d from"multiformats/block";import{sha256 as f}from"multiformats/hashes/sha2";import*as h from"multiformats/codecs/raw";import*as g from"@ipld/dag-json";import*as y from"@ipld/dag-cbor";import{CarWriter as p}from"@ipld/car/writer";import{MerkleTree as m}from"merkletreejs";import w from"keccak256";import v from"axios";function k(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then(function(e){return{value:e,done:t}})}return k=function(e){this.s=e,this.n=e.next},k.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new k(e)}function P(){return P=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},P.apply(this,arguments)}class b{constructor(e){this.nodeEndpoint=void 0,this.web3storageApiKey=void 0,this.factoryAddress=void 0,this.apikey=void 0,this.baseUrl=void 0,this.nodeEndpoint=e.nodeEndpoint||"https://api.hyperspace.node.glif.io/rpc/v1",this.baseUrl=e.baseUri||"http://localhost:5000/",this.apikey=e.apikey,this.web3storageApiKey=e.web3storageApiKey,this.factoryAddress=e.factoryAddress||"l3j4kjenwone"}invoke(e,t){const r=`${this.baseUrl}${e}`,o=P({},t,{headers:{"content-type":"application/json",apiKey:this.apikey}});return n(r,o).then(e=>{if(200===e.status)return e.json();throw new Error("call failed")})}getWeb3StorageKey(){return this.web3storageApiKey}async getProvider(){return new s.providers.JsonRpcProvider(this.nodeEndpoint)}getFactoryAddress(){return this.factoryAddress}}class S extends b{constructor(...t){var r;super(...t),r=this,this.initilizeWeb3Storage=async function(){return new c({token:r.getWeb3StorageKey()})},this.uploadCarToIPFS=async function(t){try{const o=await r.initilizeWeb3Storage(),a=e.createReadStream(`./cars/${t}.car`),i=await l.fromIterable(a),s=await o.putCar(i,{name:`${t}.car`,decoders:[y]});return console.log(`IPFS CID: ${s}`),s}catch(e){console.log(e)}},this.readData=async function(e){let t;try{return await v.get(`https://ipfs.io/api/v0/dag/get/${e}`).then(e=>{t=e.data.data}).catch(e=>{console.log(e)}),t}catch(e){console.log(e)}},this.utf8Encoder=new TextEncoder,this.utf8Decoder=new TextDecoder,this.createBlock=async function(e){const t=[];try{const r=await d.encode({value:{data:e},hasher:f,codec:y});return t.push(r),console.log(t),console.log(r.cid),{blocks:t,roots:[r.cid]}}catch(e){console.log(e)}},this.write=async function(t,r,o){try{e.existsSync("./cars")||e.mkdirSync("./cars");const{writer:a,out:i}=p.create(t);u.from(i).pipe(e.createWriteStream(`cars/${o}.car`));for(const e of r)await a.put(e),await a.close();return i}catch(e){console.log(e)}},this.read=async function(t){const o={[h.code]:h,[g.code]:g,[y.code]:y},a={[f.code]:f};try{const f=e.createReadStream(`./cars/${t}.car`),h=await l.fromIterable(f),g=(await h.getRoots(),[]);let y,p;var i,s=!1,n=!1;try{for(var c,u=function(e){var t,r,o,a=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,o=Symbol.iterator);a--;){if(r&&null!=(t=e[r]))return t.call(e);if(o&&null!=(t=e[o]))return new k(t.call(e));r="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}(h.blocks());s=!(c=await u.next()).done;s=!1){const{cid:e,bytes:t}=c.value;{const i=await d.create({cid:e,bytes:t,codec:o[e.code],hasher:a[e.multihash.code]});g.push(i);const s=i.value instanceof Uint8Array?r.utf8Decoder.decode(i.value):i.value,n=JSON.parse(JSON.stringify(s.data));y=n,p=e.toString(),console.log(`Previous Block CID: ${n.previousBlockCid}, New Block CID: ${e.toString()}`)}}}catch(e){n=!0,i=e}finally{try{s&&null!=u.return&&await u.return()}finally{if(n)throw i}}return{blockCid:p,data:y}}catch(e){console.log(e)}},this.updatPreviousBlockCid=(e,t)=>{let r=e;return r.previousBlockCid=t,r},this.updateCar1=async function(e,t){let o;try{const{blockCid:a}=await r.read(t),i=r.updatPreviousBlockCid(e,a),{blocks:s,roots:n}=await r.createBlock(i);await r.write(n,s,t),o=await r.uploadCarToIPFS(t)}catch(e){console.log(e)}return console.log(`Car Packed at: cars/${t}.car , CID: ${o}`),o},this.writeCar=async function(t,o){let a;try{const{blocks:i,roots:s}=await r.createBlock(t);await r.write(s,i,o),a=await r.uploadCarToIPFS(o),console.log(`Car Packed at: cars/${o}.car`),e.existsSync(`./cars/${o}.car`)&&e.unlinkSync(`./cars/${o}.car`)}catch(e){console.log(e)}},this.buff2Hex=e=>"0x"+e.toString("hex"),this.getMerkelTree=async function(e){try{const t=e.map(e=>w(e)),o=new m(t,w),a=r.buff2Hex(o.getRoot());return{tree:o,root:a}}catch(e){console.log(e)}},this.getleave=e=>this.buff2Hex(w(e)),this.getMerkelProof=async function(e,t){try{const{tree:o}=await r.getMerkelTree(t);return o.getProof(e).map(e=>r.buff2Hex(e.data))}catch(e){console.log(e)}},this.createProof=async function(e,t){try{const o=await r.read(t),a=P({},(function(e){if(null==e)throw new TypeError("Cannot destructure "+e)}(o),o)),i=r.getleave(e),s=await r.getMerkelProof(i,a.data.verifiers);return console.log(s),s}catch(e){console.log(e)}}}async readCid(e){return this.invoke(`storage/readData/${e}`)}async readCarData(e){return this.invoke(`storage/createCar/${e}`)}async createCar(e,t){return this.invoke(`storage/createCar/${t}`,{method:"POST",body:JSON.stringify(e)})}async uploadCar(e){return this.invoke(`storage/uploadCar/${e}`,{method:"POST"})}async updateCar(e,t){return this.invoke(`storage/createCar/${t}`,{method:"PUT",body:JSON.stringify(e)})}async getMerkelProof(e,t){return this.invoke(`storage/getMerkelProof/${e}/${t}`,{method:"GET"})}}class C extends S{constructor(...e){super(...e),this.rootFromPath="../circuit",this.rootToPath="sdk/circuit/root.zok"}async randomNumber(e){let t=[];for(let r=0;r<4;r++){const r=i(e,{entropy:!0});t.push(Math.abs(r.int32()).toString())}return t}async getNullifier(e){const t=i(e,{entropy:!1});return Math.abs(t.int32())}async fileSystemResolver(e,a){const i=r(o(r(e)),a);return t(i).toString()}async getSource(e,t){return await this.fileSystemResolver(e,t)}async getZokrateProvider(){return await a()}async getArtifacts(e){return(await this.getZokrateProvider()).compile(e)}async getPreImage(e){try{const t=await this.getZokrateProvider(),r=await this.getSource("../circuit","sdk/circuit/preImage.zok"),o=await this.getArtifacts(r),{output:a}=t.computeWitness(o,e);return JSON.parse(a)}catch(e){console.log(e)}}async generateZkProof(e){try{const t=await this.randomNumber(e),r=await this.getZokrateProvider(),o=await this.getSource(this.rootFromPath,this.rootToPath),a=await this.getArtifacts(o),i=await this.getPreImage(t),s=[...t,...i],{witness:n}=r.computeWitness(a,s),c=r.setup(a.program),l=r.generateProof(a.program,n,c.pk),u=c.vk;return{message:"ok",details:{proofBuffer:JSON.stringify(l),verifierKeyBuffer:JSON.stringify(u)}}}catch(e){return console.log(e),{message:e}}}async verifyZkProof(e){const t=e.verifierKeyBuffer,r=JSON.parse(e.proofBuffer),o=JSON.parse(t);try{const e=(await this.getZokrateProvider()).verify(o,r);return e?{message:"Ok",isVerified:e}:{message:"invalid Proof Provided",isVerified:e}}catch(e){return console.log(e),{message:e}}}async verifyZkProof1(e){return this.invoke("zk/verifyProof",{method:"POST",body:JSON.stringify(e)})}}const O=[],x=[];class $ extends C{async createTraceAgreement(e,t){try{const r=await this.getProvider(),o=new s.Contract(this.getFactoryAddress(),O,t);let a=[];const i=await o.newTraceAgreement(e,{gasLimit:21e3,maxFeePerGas:r.getGasPrice(),maxPriorityFeePerGas:r.getGasPrice()}),n=await i.wait();if(1!=n.status)throw new Error("Creation Failed");for(let e of n.events)a.push(e.event);const c=await n.events[0].args.agreementAddress,l=await n.events[0].args.id;return{message:"ok",transactionHash:n.hash,details:{agreementAddress:c,agreementId:l}}}catch(e){return console.log(e),{message:e}}}async initilizeAgreement(e,t,r){try{const o=await this.getProvider(),a=new s.Contract(t,x,r),i=(await this.getVerifiersDetails(e)).details,n=await a.initilize(i.verifiersRoot,i.nullifiers,i.argumentUri,{gasLimit:21e3,maxFeePerGas:o.getGasPrice(),maxPriorityFeePerGas:o.getGasPrice()}),c=await n.wait();if(1!=c.status)throw new Error("initilization failed");return{message:"ok",transactionHash:c.hash}}catch(e){return console.log(e),{message:e}}}async getVerifiersDetails(e){try{const t=s.utils.defaultAbiCoder,r=await this.getProvider(),{root:o}=await this.getMerkelTree(e),a=Math.round((new Date).getTime()/1e3).toString();return{message:"ok",details:{verifiersRoot:o,nullifiers:e.forEach(e=>{const o=this.getNullifier(e)*r.getBlockNumber()+a;w(t.encode(["uint"],[o]))}),argumentUri:""}}}catch(e){console.log(e)}}async verifyByOrder(e,t,r,o){try{const a=await this.getProvider(),i=new s.Contract(e,x,o);let n=[];const c=await i.verifyByOrder(t,r,{gasLimit:21e4,maxFeePerGas:a.getGasPrice(),maxPriorityFeePerGas:a.getGasPrice()}),l=await c.wait();if(1!=l.status)throw new Error("verification failed");for(let e of l.events)n.push(e.event);return{message:"ok",details:{verifiedCount:await l.events[0].args.signCount,verified:await l.events[0].args.verified}}}catch(e){return console.log(e),{message:e}}}}class T extends ${}var A;A=T,[$].forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(t=>{Object.defineProperty(A.prototype,t,Object.getOwnPropertyDescriptor(e.prototype,t)||Object.create(null))})});export{T as default};
