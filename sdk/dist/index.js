var e=require("fs"),t=require("path"),r=require("zokrates-js"),n=require("keccak256"),i=require("ethers"),s=require("seedrandom"),o=require("isomorphic-unfetch"),a=require("web3.storage"),u=require("@ipld/car/reader"),c=require("readable-stream"),l=require("multiformats/block"),y=require("multiformats/hashes/sha2"),p=require("multiformats/codecs/raw"),d=require("@ipld/dag-json"),m=require("@ipld/dag-cbor"),f=require("@ipld/car/writer"),h=require("merkletreejs"),v=require("axios");function b(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function P(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var g=/*#__PURE__*/P(e),T=/*#__PURE__*/b(n),w=/*#__PURE__*/b(s),A=/*#__PURE__*/b(o),k=/*#__PURE__*/P(l),M=/*#__PURE__*/P(p),S=/*#__PURE__*/P(d),x=/*#__PURE__*/P(m),j=/*#__PURE__*/b(v);class E{constructor(e){this.nodeEndpoint=void 0,this.web3storageApiKey=void 0,this.factoryAddress=void 0,this.apikey=void 0,this.baseUrl=void 0,this.traceHubAddress=void 0,this.nodeEndpoint=e.nodeEndpoint||"http://127.0.0.1:8545",this.baseUrl=e.baseUri||"http://localhost:5000/",this.apikey=e.apikey,this.web3storageApiKey=e.web3storageApiKey,this.factoryAddress=e.factoryAddress||"0x610178da211fef7d417bc0e6fed39f05609ad788",this.traceHubAddress=e.traceHubAddress||"0x8A791620dd6260079BF849Dc5567aDC3F2FdC318"}invoke(e,t){const r={...t,headers:{"content-type":"application/json",apiKey:this.apikey}};return A.default(`${this.baseUrl}${e}`,r).then(e=>{if(200===e.status)return e.json();throw new Error("call failed")})}getWeb3StorageKey(){return this.web3storageApiKey}getProvider(){try{return Promise.resolve(new i.ethers.providers.JsonRpcProvider(this.nodeEndpoint))}catch(e){return Promise.reject(e)}}getFactoryAddress(){return this.factoryAddress}getTraceHubAddress(){return this.traceHubAddress}}function C(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}const R="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function O(e,t,r){if(!e.s){if(r instanceof _){if(!r.s)return void(r.o=O.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(O.bind(null,e,t),O.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}const _=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,i=this.s;if(i){const e=1&i?t:r;if(e){try{O(n,1,e(this.v))}catch(e){O(n,2,e)}return n}return this}return this.o=function(e){try{const i=e.v;1&e.s?O(n,1,t?t(i):i):r?O(n,1,r(i)):O(n,2,i)}catch(e){O(n,2,e)}},n},e}();function D(e){return e instanceof _&&1&e.s}function F(e,t,r){if("function"==typeof e[R]){var n,i,s,o=e[R]();if(function e(a){try{for(;!((n=o.next()).done||r&&r());)if((a=t(n.value))&&a.then){if(!D(a))return void a.then(e,s||(s=O.bind(null,i=new _,2)));a=a.v}i?O(i,1,a):i=a}catch(e){O(i||(i=new _),2,e)}}(),o.return){var a=function(e){try{n.done||o.return()}catch(e){}return e};if(i&&i.then)return i.then(a,function(e){throw a(e)});a()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var u=[],c=0;c<e.length;c++)u.push(e[c]);return function(e,t,r){var n,i,s=-1;return function o(a){try{for(;++s<e.length&&(!r||!r());)if((a=t(s))&&a.then){if(!D(a))return void a.then(o,i||(i=O.bind(null,n=new _,2)));a=a.v}n?O(n,1,a):n=a}catch(e){O(n||(n=new _),2,e)}}(),n}(u,function(e){return t(u[e])},r)}const H="undefined"!=typeof Symbol?Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")):"@@asyncIterator";class I extends E{constructor(){super(...arguments);const e=this,t=this,r=this,n=this,i=this,s=this,o=this,l=this;this.initilizeWeb3Storage=function(){try{return Promise.resolve(l.getWeb3StorageKey()).then(function(e){return new a.Web3Storage({token:e})})}catch(e){return Promise.reject(e)}},this.uploadCarToIPFS=function(e){try{return Promise.resolve(C(function(){return Promise.resolve(o.initilizeWeb3Storage()).then(function(t){const r=g.createReadStream(`./cars/${e}.car`);return Promise.resolve(u.CarReader.fromIterable(r)).then(function(r){return Promise.resolve(t.putCar(r,{name:`${e}.car`,decoders:[x]}))})})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}},this.readData=function(e){try{let t;return Promise.resolve(C(function(){return Promise.resolve(j.default.get(`https://ipfs.io/api/v0/dag/get/${e}`).then(e=>{t=e.data.data}).catch(e=>{throw new Error(e)})).then(function(){return t})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}},this.utf8Encoder=new TextEncoder,this.utf8Decoder=new TextDecoder,this.createBlock=function(e){try{const t=[];return Promise.resolve(C(function(){return Promise.resolve(k.encode({value:{data:e},hasher:y.sha256,codec:x})).then(function(e){return t.push(e),{blocks:t,roots:[e.cid]}})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}},this.write=function(e,t,r){try{return Promise.resolve(C(function(){g.existsSync("./cars")||g.mkdirSync("./cars");const{writer:n,out:i}=f.CarWriter.create(e);c.Readable.from(i).pipe(g.createWriteStream(`cars/${r}.car`));const s=F(t,function(e){return Promise.resolve(n.put(e)).then(function(){return Promise.resolve(n.close()).then(function(){})})});return s&&s.then?s.then(function(){return i}):i},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}},this.readCar=function(e){try{const t={[M.code]:M,[S.code]:S,[x.code]:x},r={[y.sha256.code]:y.sha256};return Promise.resolve(C(function(){const n=g.createReadStream(e);return Promise.resolve(u.CarReader.fromIterable(n)).then(function(e){return Promise.resolve(e.getRoots()).then(function(n){function i(){return{blockCid:u,data:a}}const o=[];let a,u;const c=function(e,t,r){if("function"==typeof e[H]){var n=new _,i=e[H]();return i.next().then(o).then(void 0,a),n;function s(e){if(r&&r())return O(n,1,i.return?i.return().then(function(){return e}):e);i.next().then(o).then(void 0,a)}function o(e){e.done?O(n,1):Promise.resolve(t(e.value)).then(s).then(void 0,a)}function a(e){O(n,2,i.return?i.return().then(function(){return e}):e)}}return Promise.resolve(F(e,function(e){return Promise.resolve(e).then(t)},r))}(e.blocks(),function(e){let{cid:n,bytes:i}=e;return Promise.resolve(k.create({cid:n,bytes:i,codec:t[n.code],hasher:r[n.multihash.code]})).then(function(e){o.push(e);const t=e.value instanceof Uint8Array?s.utf8Decoder.decode(e.value):e.value,r=JSON.parse(JSON.stringify(t.data));a=r,u=n.toString()})});return c&&c.then?c.then(i):i()})})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}},this.updatPreviousBlockCid=(e,t)=>{let r=e;return r.previousBlockCid=t,r},this.updateCar1=function(e,t,r){try{let n;return Promise.resolve(C(function(){const s=i.updatPreviousBlockCid(e,r);return Promise.resolve(i.createBlock(s)).then(function(e){let{blocks:r,roots:s}=e;return Promise.resolve(i.write(s,r,t)).then(function(){return Promise.resolve(i.uploadCarToIPFS(t)).then(function(e){return n=e,n})})})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}},this.writeCar=function(e,t){try{let r;return Promise.resolve(C(function(){return Promise.resolve(n.createBlock(e)).then(function(e){let{blocks:i,roots:s}=e;return Promise.resolve(n.write(s,i,t)).then(function(){return Promise.resolve(n.uploadCarToIPFS(t)).then(function(e){return r=e,{message:"ok",cid:r}})})})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}},this.buff2Hex=e=>"0x"+e.toString("hex"),this.getMerkelTree=function(e){try{try{const t=e.map(e=>r.buff2Hex(T.default(e))),n=new h.MerkleTree(t,T.default,{sortPairs:!0}),i=r.buff2Hex(n.getRoot());return Promise.resolve({tree:n,root:i})}catch(e){throw new Error(e)}}catch(e){return Promise.reject(e)}},this.getleave=e=>this.buff2Hex(T.default(e)),this.verifyMerkelProof=function(e,r,n){try{return Promise.resolve(C(function(){return Promise.resolve(t.getMerkelTree(n)).then(function(n){let{tree:i,root:s}=n;const o=t.getleave(r);return i.verify(e,o,s)})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}},this.createProof=function(t,r){try{return Promise.resolve(C(function(){const n=e.getleave(t);return Promise.resolve(e.getMerkelProof1(n,r))},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}}}readCid(e){try{return Promise.resolve(this.invoke(`storage/readData/${e}`))}catch(e){return Promise.reject(e)}}readCarData(e){try{return Promise.resolve(this.invoke(`storage/createCar/${e}`))}catch(e){return Promise.reject(e)}}createCar(e,t){try{return Promise.resolve(this.invoke(`storage/createCar/${t}`,{method:"POST",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}uploadCar(e){try{return Promise.resolve(this.invoke(`storage/uploadCar/${e}`,{method:"POST"}))}catch(e){return Promise.reject(e)}}updateCar(e,t){try{return Promise.resolve(this.invoke(`storage/createCar/${t}`,{method:"PUT",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}getMerkelProof(e,t){try{return Promise.resolve(this.invoke(`storage/getMerkelProof/${e}/${t}`,{method:"GET"}))}catch(e){return Promise.reject(e)}}getMerkelProof1(e,t){try{const r=this;return Promise.resolve(C(function(){return Promise.resolve(r.getMerkelTree(t)).then(function(t){let{tree:r}=t;return r.getHexProof(e)})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}}}function N(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}class U extends I{constructor(){super(...arguments),this.rootFromPath="../circuit",this.rootToPath="sdk/circuit/root.zok"}randomNumber(e){try{let t=[];for(let r=0;r<4;r++){const r=w.default(e,{entropy:!0});t.push(Math.abs(r.int32()).toString())}return Promise.resolve(t)}catch(e){return Promise.reject(e)}}getNullifier(e){try{const t=w.default(e,{entropy:!1});return Promise.resolve(Math.abs(t.int32()))}catch(e){return Promise.reject(e)}}fileSystemResolver(r,n){try{const i=t.resolve(t.dirname(t.resolve(r)),n),s=e.readFileSync(i).toString();return Promise.resolve(s)}catch(e){return Promise.reject(e)}}getSource(e,t){try{return Promise.resolve(this.fileSystemResolver(e,t))}catch(e){return Promise.reject(e)}}getZokrateProvider(){try{return Promise.resolve(r.initialize())}catch(e){return Promise.reject(e)}}getArtifacts(e){try{return Promise.resolve(this.getZokrateProvider()).then(function(t){return t.compile(e)})}catch(e){return Promise.reject(e)}}getPreImage(e){try{const t=this;return Promise.resolve(N(function(){return Promise.resolve(t.getZokrateProvider()).then(function(r){return Promise.resolve(t.getSource("../circuit","sdk/circuit/preImage.zok")).then(function(n){return Promise.resolve(t.getArtifacts(n)).then(function(t){const{output:n}=r.computeWitness(t,e);return JSON.parse(n)})})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}}generateZkProof(e){try{const t=this;return Promise.resolve(N(function(){const r=i.ethers.utils.defaultAbiCoder;return Promise.resolve(t.getProvider()).then(function(n){const i=parseInt(Math.round((new Date).getTime()/1e3).toString());return Promise.resolve(t.randomNumber(e)).then(function(s){return Promise.resolve(t.getNullifier(e)).then(function(o){return Promise.resolve(t.getZokrateProvider()).then(function(a){return Promise.resolve(t.getSource(t.rootFromPath,t.rootToPath)).then(function(u){return Promise.resolve(t.getArtifacts(u)).then(function(u){return Promise.resolve(t.getPreImage(s)).then(function(c){return Promise.resolve(n.getBlockNumber()).then(function(n){const l=t.buff2Hex(T.default(r.encode(["uint","uint","uint","string"],[o,i,n,e]))),y=[...s,...c],{witness:p}=a.computeWitness(u,y),d=a.setup(u.program),m=a.generateProof(u.program,p,d.pk),f=d.vk;return{message:"ok",details:{proofBuffer:JSON.stringify(m),verifierKeyBuffer:JSON.stringify(f),nullifier:l}}})})})})})})})})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}}verifyZkProof(e){try{const t=this,r=e.verifierKeyBuffer,n=JSON.parse(e.proofBuffer),i=JSON.parse(r);return Promise.resolve(N(function(){return Promise.resolve(t.getZokrateProvider()).then(function(e){const t=e.verify(i,n);return t?{message:"Ok",isVerified:t}:{message:"invalid Proof Provided",isVerified:t}})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}}verifyZkProof1(e){try{return Promise.resolve(this.invoke("zk/verifyProof",{method:"POST",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}}const B=[{inputs:[{internalType:"address",name:"_traceHub",type:"address"},{internalType:"address",name:"_traceAgreementImplementation",type:"address"}],stateMutability:"nonpayable",type:"constructor"},{anonymous:!1,inputs:[{indexed:!0,internalType:"uint256",name:"time",type:"uint256"},{indexed:!0,internalType:"address",name:"agreementAddress",type:"address"},{indexed:!0,internalType:"uint256",name:"id",type:"uint256"}],name:"AgreementCreated",type:"event"},{inputs:[{internalType:"address",name:"agreementAddress",type:"address"}],name:"getAgreementDetais",outputs:[{components:[{internalType:"bytes32",name:"verifierRoot",type:"bytes32"},{internalType:"bytes32[]",name:"nullifiers",type:"bytes32[]"},{internalType:"string",name:"agreementUri",type:"string"},{internalType:"uint256",name:"agreementId",type:"uint256"}],internalType:"struct TraceAgreementFactory.TraceAgreementDetails",name:"",type:"tuple"}],stateMutability:"view",type:"function"},{inputs:[],name:"getFactoryAddress",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"agreementAddress",type:"address"}],name:"getId",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"id",type:"uint256"}],name:"getTraceAddress",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"_verifierRoot",type:"bytes32"},{internalType:"bytes32[]",name:"_nullifiers",type:"bytes32[]"},{internalType:"string",name:"agreementUri",type:"string"},{internalType:"address",name:"_traceAgreement",type:"address"}],name:"initilizeAgreement",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"traceAdmin",type:"address"},{internalType:"address",name:"_supplier",type:"address"}],name:"newTraceAgreement",outputs:[{internalType:"address",name:"",type:"address"},{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"traceHub",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"}],q=[{inputs:[{internalType:"address",name:"hubAdmin",type:"address"}],stateMutability:"nonpayable",type:"constructor"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"newDefaultAdmin",type:"address"}],name:"DeafultAdminChanged",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bool",name:"accepted",type:"bool"}],name:"ProposalAccepted",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"role",type:"bytes32"},{indexed:!0,internalType:"bytes32",name:"previousAdminRole",type:"bytes32"},{indexed:!0,internalType:"bytes32",name:"newAdminRole",type:"bytes32"}],name:"RoleAdminChanged",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"hubAdmin",type:"address"}],name:"RoleGranted",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"role",type:"bytes32"},{indexed:!0,internalType:"address",name:"account",type:"address"},{indexed:!0,internalType:"address",name:"sender",type:"address"}],name:"RoleGranted",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"address",name:"hubAdmin",type:"address"}],name:"RoleRevoked",type:"event"},{anonymous:!1,inputs:[{indexed:!0,internalType:"bytes32",name:"role",type:"bytes32"},{indexed:!0,internalType:"address",name:"account",type:"address"},{indexed:!0,internalType:"address",name:"sender",type:"address"}],name:"RoleRevoked",type:"event"},{inputs:[],name:"DEFAULT_ADMIN_ROLE",outputs:[{internalType:"bytes32",name:"",type:"bytes32"}],stateMutability:"view",type:"function"},{inputs:[],name:"HUB_ADMIN",outputs:[{internalType:"bytes32",name:"",type:"bytes32"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"traceAddress",type:"address"}],name:"acceptProposal",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"_traceFactory",type:"address"}],name:"addFactory",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"newDeafultAdmin",type:"address"}],name:"changeDeafultAdmin",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"addr",type:"address"}],name:"checkDeafultAdmin",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"hubAdmin",type:"address"}],name:"checkHubAdmin",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"traceAddress",type:"address"},{internalType:"bytes32",name:"nullifier",type:"bytes32"}],name:"checkNullExist",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"}],name:"checkNullLength",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"},{internalType:"bytes32",name:"_nullifier",type:"bytes32"}],name:"checkNullifier",outputs:[{internalType:"bool",name:"",type:"bool"},{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"traceAddress",type:"address"}],name:"checkSupplierApproved",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"}],name:"getAgreementDetails",outputs:[{internalType:"address",name:"",type:"address"},{internalType:"uint256",name:"",type:"uint256"},{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"}],name:"getAgreementId",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getAgreementLog",outputs:[{components:[{internalType:"address",name:"traceAgreementContract",type:"address"},{internalType:"uint256",name:"id",type:"uint256"},{internalType:"uint256",name:"createdAt",type:"uint256"},{internalType:"string",name:"uri",type:"string"},{internalType:"bytes32[]",name:"nullifiers",type:"bytes32[]"}],internalType:"struct TraceHub.Agreement[]",name:"",type:"tuple[]"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"}],name:"getAgreementUri",outputs:[{internalType:"string",name:"",type:"string"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"role",type:"bytes32"}],name:"getRoleAdmin",outputs:[{internalType:"bytes32",name:"",type:"bytes32"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"uint256",name:"id",type:"uint256"}],name:"getTraceAddress",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"hubAdmin",type:"address"}],name:"grantAdminRole",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"role",type:"bytes32"},{internalType:"address",name:"account",type:"address"}],name:"grantRole",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"role",type:"bytes32"},{internalType:"address",name:"account",type:"address"}],name:"hasRole",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"traceAddress",type:"address"},{internalType:"bytes32",name:"nullifier",type:"bytes32"}],name:"initiateAgreement",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"addr",type:"address"}],name:"removeRole",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"role",type:"bytes32"},{internalType:"address",name:"account",type:"address"}],name:"renounceRole",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes32",name:"role",type:"bytes32"},{internalType:"address",name:"account",type:"address"}],name:"revokeRole",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"bytes4",name:"interfaceId",type:"bytes4"}],name:"supportsInterface",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"},{internalType:"string",name:"agreementUri",type:"string"},{internalType:"bytes32[]",name:"_nullifiers",type:"bytes32[]"},{internalType:"uint256",name:"id",type:"uint256"}],name:"updatAgreementLog",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"},{internalType:"string",name:"agreementUri",type:"string"}],name:"updatAgreementUri",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"_traceAgreement",type:"address"},{internalType:"bytes32",name:"_nullifier",type:"bytes32"}],name:"updateNullifier",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"traceAddress",type:"address"},{internalType:"bytes32",name:"nullifier",type:"bytes32"}],name:"zkProof",outputs:[],stateMutability:"nonpayable",type:"function"}],z=[{anonymous:!1,inputs:[{indexed:!0,internalType:"uint256",name:"signCount",type:"uint256"},{indexed:!0,internalType:"bool",name:"verified",type:"bool"}],name:"Verified",type:"event"},{inputs:[],name:"activate",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"},{inputs:[{internalType:"address",name:"_traceAdmin",type:"address"},{internalType:"address",name:"_supplier",type:"address"},{internalType:"address",name:"_factoryAddress",type:"address"},{internalType:"address",name:"_traceHub",type:"address"}],name:"addTraceAdmin",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"checkState",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getAgreementId",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"},{inputs:[],name:"getSupplier",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[],name:"getTraceAdmin",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32",name:"_verifierRoot",type:"bytes32"},{internalType:"bytes32[]",name:"_nullifiers",type:"bytes32[]"},{internalType:"string",name:"agreementUri",type:"string"}],name:"initilize",outputs:[],stateMutability:"nonpayable",type:"function"},{inputs:[],name:"status",outputs:[{internalType:"enum TraceAgreement.AgreementStatus",name:"",type:"uint8"}],stateMutability:"view",type:"function"},{inputs:[],name:"traceHub",outputs:[{internalType:"address",name:"",type:"address"}],stateMutability:"view",type:"function"},{inputs:[{internalType:"bytes32[]",name:"_proof",type:"bytes32[]"},{internalType:"bytes32",name:"nullifier",type:"bytes32"}],name:"verifyByOrder",outputs:[{internalType:"bool",name:"",type:"bool"}],stateMutability:"nonpayable",type:"function"}];function G(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}function $(e,t,r){if(!e.s){if(r instanceof K){if(!r.s)return void(r.o=$.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then($.bind(null,e,t),$.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}const K=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,i=this.s;if(i){const e=1&i?t:r;if(e){try{$(n,1,e(this.v))}catch(e){$(n,2,e)}return n}return this}return this.o=function(e){try{const i=e.v;1&e.s?$(n,1,t?t(i):i):r?$(n,1,r(i)):$(n,2,i)}catch(e){$(n,2,e)}},n},e}();function Z(e,t,r){var n,i,s=-1;return function o(a){try{for(;++s<e.length&&(!r||!r());)if((a=t(s))&&a.then){if(!((u=a)instanceof K&&1&u.s))return void a.then(o,i||(i=$.bind(null,n=new K,2)));a=a.v}n?$(n,1,a):n=a}catch(e){$(n||(n=new K),2,e)}var u}(),n}class J extends U{createTraceAgreement(e,t,r){try{const n=this;return Promise.resolve(G(function(){return Promise.resolve(n.getProvider()).then(function(s){const o=new i.ethers.Contract(n.getFactoryAddress(),B,r);let a=[];return Promise.resolve(o.newTraceAgreement(e,t)).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1!=e.status)throw new Error("Creation Failed");for(let t of e.events)a.push(t.event);return Promise.resolve(e.events[0].args.agreementAddress).then(function(t){return Promise.resolve(e.events[0].args.id).then(function(r){return{message:"ok",transactionHash:e.transactionHash,details:{agreementAddress:t,agreementId:r.toString()}}})})})})})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}}acceptProposal(e,t){try{const r=this;return Promise.resolve(G(function(){let n=[];const s=new i.ethers.Contract(r.getTraceHubAddress(),q,t);return Promise.resolve(s.acceptProposal(e,{gasLimit:21e4,maxFeePerGas:i.ethers.utils.parseUnits("80","gwei"),maxPriorityFeePerGas:i.ethers.utils.parseUnits("80","gwei")})).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1!=e.status)throw new Error("verification failed");for(let t of e.events)n.push(t.event);return Promise.resolve(e.events[0].args.accepted)})})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}}initilizeAgreement(e,t,r,n){try{const s=this;return Promise.resolve(G(function(){const o=[];return Promise.resolve(s.getProvider()).then(function(a){const u=new i.ethers.Contract(t,z,n);return Promise.resolve(s.getVerifiersDetails(e)).then(function(n){const a=n.details;return Promise.resolve(s.writeCar({traceAddress:t,verifiersRoot:a.verifiersRoot,verifiers:e,txDetails:r,previousBlockCid:""},t)).then(function(t){return Promise.resolve(u.initilize(a.verifiersRoot,a.nullifiers,t.cid,{gasLimit:21e6,maxFeePerGas:i.ethers.utils.parseUnits("80","gwei"),maxPriorityFeePerGas:i.ethers.utils.parseUnits("80","gwei")})).then(function(t){return Promise.resolve(t.wait()).then(function(t){function r(){return{message:"ok",transactionHash:t.transactionHash,verificationDetails:o}}if(1!=t.status)throw new Error("initilization failed");const n=Z(e,function(t){return Promise.resolve(s.createProof(e[t],e)).then(function(r){const n=a.nullifiers[t],i=e[t];return Promise.resolve(r).then(function(e){o.push({verifier:i,nullifier:n,merkelProof:e})})})});return n&&n.then?n.then(r):r()})})})})})},function(e){throw console.log(e),new Error(e)}))}catch(e){return Promise.reject(e)}}getVerifiersProof(e){try{const t=this,r=[],n=Z(e,function(n){return Promise.resolve(t.createProof(e[n],e)).then(function(t){const i=e[n];return Promise.resolve(t).then(function(e){r.push({verifier:i,merkelProof:e})})})});return Promise.resolve(n&&n.then?n.then(function(){return r}):r)}catch(e){return Promise.reject(e)}}verifyByOrder(e,t,r,n){try{const s=this;return Promise.resolve(G(function(){return Promise.resolve(s.getProvider()).then(function(s){const o=new i.ethers.Contract(e,z,n);let a=[];return Promise.resolve(o.verifyByOrder(t,r,{gasLimit:21e4,maxFeePerGas:i.ethers.utils.parseUnits("80","gwei"),maxPriorityFeePerGas:i.ethers.utils.parseUnits("80","gwei")})).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1!=e.status)throw new Error("verification failed");for(let t of e.events)a.push(t.event);return Promise.resolve(e.events[0].args.signCount).then(function(t){return Promise.resolve(e.events[0].args.verified).then(function(e){return{message:"ok",details:{verifiedCount:t,verified:e}}})})})})})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}}createZkProof(e,t){try{const r=this;return Promise.resolve(G(function(){return Promise.resolve(r.getProvider()).then(function(n){return Promise.resolve(r.generateZkProof(e)).then(function(n){const s=new i.ethers.Contract(r.getTraceHubAddress(),q,t);return Promise.resolve(s.checkSupplierApproved(e)).then(function(t){if(!t)throw new Error("Supplier has not approved");return Promise.resolve(s.zkProof(e,n.details.nullifier,{gasLimit:21e6,maxFeePerGas:i.ethers.utils.parseUnits("80","gwei"),maxPriorityFeePerGas:i.ethers.utils.parseUnits("80","gwei")})).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1!=e.status)throw new Error("verification failed");return n.details})})})})})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}}activateTraceAgreement(e,t,r){try{const n=this;return Promise.resolve(G(function(){return Promise.resolve(n.getProvider()).then(function(s){const o=new i.ethers.Contract(n.getTraceHubAddress(),q,r);return Promise.resolve(o.checkNullExist(e,t.nullifier)).then(function(r){if(!r)throw new Error("Invalid Nullifier");return Promise.resolve(n.verifyZkProof({proofBuffer:t.proofBuffer,verifierKeyBuffer:t.verifierKeyBuffer})).then(function(r){if("Ok"!=r.message)throw new Error("Invalid ZK Proof Provided");return Promise.resolve(o.initiateAgreement(e,t.nullifier,{gasLimit:21e6,maxFeePerGas:i.ethers.utils.parseUnits("80","gwei"),maxPriorityFeePerGas:i.ethers.utils.parseUnits("80","gwei")})).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1!=e.status)throw new Error("failed to initiate");return{message:"ok"}})})})})})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}}getVerifiersDetails(e){try{const t=this;return Promise.resolve(G(function(){let r=[];const n=i.ethers.utils.defaultAbiCoder;return Promise.resolve(t.getProvider()).then(function(i){return Promise.resolve(t.getMerkelTree(e)).then(function(i){let{root:s}=i;const o=parseInt(Math.round((new Date).getTime()/1e3).toString());return e.forEach(function(e){try{return Promise.resolve(t.getNullifier(e)).then(function(e){r.push(t.buff2Hex(T.default(n.encode(["uint","uint"],[e,o]))))})}catch(e){return Promise.reject(e)}}),{message:"ok",details:{verifiersRoot:s,nullifiers:r}}})})},function(e){throw new Error(e)}))}catch(e){return Promise.reject(e)}}}class L extends J{}var W;W=L,[J].forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(t=>{Object.defineProperty(W.prototype,t,Object.getOwnPropertyDescriptor(e.prototype,t)||Object.create(null))})}),module.exports=L;
