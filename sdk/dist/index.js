var e=require("fs"),r=require("path"),t=require("zokrates-js"),o=require("seedrandom"),s=require("ethers"),n=require("isomorphic-unfetch");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=/*#__PURE__*/i(o),a=/*#__PURE__*/i(n);class u{constructor(e){this.nodeEndpoint=void 0,this.apikey=void 0,this.baseUrl=void 0,this.nodeEndpoint=e.nodeEndpoint||"https://api.hyperspace.node.glif.io/rpc/v1",this.baseUrl=e.baseUri||"http://localhost:5000/",this.apikey=e.apikey}invoke(e,r){const t={...r,headers:{"content-type":"application/json",apiKey:this.apikey}};return a.default(`${this.baseUrl}${e}`,t).then(e=>{if(200===e.status)return e.json();throw new Error("call failed")})}getProvider(){try{return Promise.resolve(new s.ethers.providers.JsonRpcProvider(this.nodeEndpoint))}catch(e){return Promise.reject(e)}}}class h extends u{readCid(e){try{return Promise.resolve(this.invoke(`storage/readData/${e}`))}catch(e){return Promise.reject(e)}}readCarData(e){try{return Promise.resolve(this.invoke(`storage/createCar/${e}`))}catch(e){return Promise.reject(e)}}createCar(e,r){try{return Promise.resolve(this.invoke(`storage/createCar/${r}`,{method:"POST",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}uploadCar(e){try{return Promise.resolve(this.invoke(`storage/uploadCar/${e}`,{method:"POST"}))}catch(e){return Promise.reject(e)}}updateCar(e,r){try{return Promise.resolve(this.invoke(`storage/createCar/${r}`,{method:"PUT",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}getMerkelProof(e,r){try{return Promise.resolve(this.invoke(`storage/getMerkelProof/${e}/${r}`,{method:"GET"}))}catch(e){return Promise.reject(e)}}}function l(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}class m extends h{constructor(){super(...arguments),this.rootFromPath="../circuit",this.rootToPath="sdk/circuit/root.zok"}randomNumber(e){try{let r=[];for(let t=0;t<4;t++){const t=c.default(e,{entropy:!0});r.push(Math.abs(t.int32()).toString())}return Promise.resolve(r)}catch(e){return Promise.reject(e)}}getNullifier(e){try{const r=c.default(e,{entropy:!1});return Promise.resolve(Math.abs(r.int32()))}catch(e){return Promise.reject(e)}}generateZkProof(e){try{return Promise.resolve(this.invoke("zk/generateProof",{method:"POST",body:JSON.stringify({input:e})}))}catch(e){return Promise.reject(e)}}verifyZkProof(e){try{return Promise.resolve(this.invoke("zk/verifyProof",{method:"POST",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}fileSystemResolver(t,o){try{const s=r.resolve(r.dirname(r.resolve(t)),o),n=e.readFileSync(s).toString();return Promise.resolve(n)}catch(e){return Promise.reject(e)}}getSource(e,r){try{return Promise.resolve(this.fileSystemResolver(e,r))}catch(e){return Promise.reject(e)}}getZokrateProvider(){try{return Promise.resolve(t.initialize())}catch(e){return Promise.reject(e)}}getArtifacts(e){try{return Promise.resolve(this.getZokrateProvider()).then(function(r){return r.compile(e)})}catch(e){return Promise.reject(e)}}getPreImage(e){try{const r=this;return Promise.resolve(l(function(){return Promise.resolve(r.getZokrateProvider()).then(function(t){return Promise.resolve(r.getSource("../circuit","sdk/circuit/preImage.zok")).then(function(o){return Promise.resolve(r.getArtifacts(o)).then(function(r){const{output:o}=t.computeWitness(r,e);return JSON.parse(o)})})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}}generateZkProof1(e){try{const r=this;return Promise.resolve(l(function(){return Promise.resolve(r.randomNumber(e)).then(function(e){return Promise.resolve(r.getZokrateProvider()).then(function(t){return Promise.resolve(r.getSource(r.rootFromPath,r.rootToPath)).then(function(o){return Promise.resolve(r.getArtifacts(o)).then(function(o){return Promise.resolve(r.getPreImage(e)).then(function(r){const s=[...e,...r],{witness:n}=t.computeWitness(o,s),i=t.setup(o.program),c=t.generateProof(o.program,n,i.pk),a=i.vk;return{message:"ok",details:{proofBuffer:JSON.stringify(c),verifierKeyBuffer:JSON.stringify(a)}}})})})})})},function(e){return console.log(e),{message:e}}))}catch(e){return Promise.reject(e)}}verifyZkProof1(e){try{const r=this,t=e.verifierKeyBuffer,o=JSON.parse(e.proofBuffer),s=JSON.parse(t);return Promise.resolve(l(function(){return Promise.resolve(r.getZokrateProvider()).then(function(e){const r=e.verify(s,o);return console.log(r),r})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}}}const P=[];class f extends m{createTraceAgreement(e,r,t){try{try{new s.ethers.Contract(r,P,t)}catch(e){console.log(e)}return Promise.resolve()}catch(e){return Promise.reject(e)}}}class v extends f{}var d;d=v,[f].forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(r=>{Object.defineProperty(d.prototype,r,Object.getOwnPropertyDescriptor(e.prototype,r)||Object.create(null))})}),module.exports=v;
