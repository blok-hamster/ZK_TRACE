import*as e from"fs";import{readFileSync as r}from"fs";import{resolve as t,dirname as o}from"path";import{initialize as n}from"zokrates-js";import i from"seedrandom";import{ethers as s}from"ethers";import c from"isomorphic-unfetch";import{Web3Storage as u}from"web3.storage";import{CarReader as a}from"@ipld/car/reader";import{Readable as l}from"stream";import*as f from"multiformats/block";import{sha256 as h}from"multiformats/hashes/sha2";import*as m from"multiformats/codecs/raw";import*as d from"@ipld/dag-json";import*as v from"@ipld/dag-cbor";import{CarWriter as P}from"@ipld/car/writer";import{MerkleTree as g}from"merkletreejs";import y from"keccak256";import p from"axios";class k{constructor(e){this.nodeEndpoint=void 0,this.web3storageApiKey=void 0,this.factoryAddress=void 0,this.apikey=void 0,this.baseUrl=void 0,this.nodeEndpoint=e.nodeEndpoint||"https://api.hyperspace.node.glif.io/rpc/v1",this.baseUrl=e.baseUri||"http://localhost:5000/",this.apikey=e.apikey,this.web3storageApiKey=e.web3storageApiKey,this.factoryAddress=e.factoryAddress||"l3j4kjenwone"}invoke(e,r){const t={...r,headers:{"content-type":"application/json",apiKey:this.apikey}};return c(`${this.baseUrl}${e}`,t).then(e=>{if(200===e.status)return e.json();throw new Error("call failed")})}getWeb3StorageKey(){return this.web3storageApiKey}getProvider(){try{return Promise.resolve(new s.providers.JsonRpcProvider(this.nodeEndpoint))}catch(e){return Promise.reject(e)}}getFactoryAddress(){return this.factoryAddress}}function b(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}const S="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function w(e,r,t){if(!e.s){if(t instanceof j){if(!t.s)return void(t.o=w.bind(null,e,r));1&r&&(r=t.s),t=t.v}if(t&&t.then)return void t.then(w.bind(null,e,r),w.bind(null,e,2));e.s=r,e.v=t;const o=e.o;o&&o(e)}}const j=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(r,t){const o=new e,n=this.s;if(n){const e=1&n?r:t;if(e){try{w(o,1,e(this.v))}catch(e){w(o,2,e)}return o}return this}return this.o=function(e){try{const n=e.v;1&e.s?w(o,1,r?r(n):n):t?w(o,1,t(n)):w(o,2,n)}catch(e){w(o,2,e)}},o},e}();function C(e){return e instanceof j&&1&e.s}function x(e,r,t){if("function"==typeof e[S]){var o,n,i,s=e[S]();if(function e(c){try{for(;!((o=s.next()).done||t&&t());)if((c=r(o.value))&&c.then){if(!C(c))return void c.then(e,i||(i=w.bind(null,n=new j,2)));c=c.v}n?w(n,1,c):n=c}catch(e){w(n||(n=new j),2,e)}}(),s.return){var c=function(e){try{o.done||s.return()}catch(e){}return e};if(n&&n.then)return n.then(c,function(e){throw c(e)});c()}return n}if(!("length"in e))throw new TypeError("Object is not iterable");for(var u=[],a=0;a<e.length;a++)u.push(e[a]);return function(e,r,t){var o,n,i=-1;return function s(c){try{for(;++i<e.length&&(!t||!t());)if((c=r(i))&&c.then){if(!C(c))return void c.then(s,n||(n=w.bind(null,o=new j,2)));c=c.v}o?w(o,1,c):o=c}catch(e){w(o||(o=new j),2,e)}}(),o}(u,function(e){return r(u[e])},t)}const O="undefined"!=typeof Symbol?Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")):"@@asyncIterator";class $ extends k{constructor(){super(...arguments);const r=this,t=this,o=this,n=this,i=this,s=this,c=this,k=this;this.initilizeWeb3Storage=function(){try{const e=new u({token:k.getWeb3StorageKey()});return Promise.resolve(e)}catch(e){return Promise.reject(e)}},this.uploadCarToIPFS=function(r){try{return Promise.resolve(b(function(){return Promise.resolve(c.initilizeWeb3Storage()).then(function(t){const o=e.createReadStream(`./cars/${r}.car`);return Promise.resolve(a.fromIterable(o)).then(function(e){return Promise.resolve(t.putCar(e,{name:`${r}.car`,decoders:[v]})).then(function(e){return console.log(`IPFS CID: ${e}`),e})})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.readData=function(e){try{let r;return Promise.resolve(b(function(){return Promise.resolve(p.get(`https://ipfs.io/api/v0/dag/get/${e}`).then(e=>{r=e.data.data}).catch(e=>{console.log(e)})).then(function(){return r})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.utf8Encoder=new TextEncoder,this.utf8Decoder=new TextDecoder,this.createBlock=function(e){try{const r=[];return Promise.resolve(b(function(){return Promise.resolve(f.encode({value:{data:e},hasher:h,codec:v})).then(function(e){return r.push(e),console.log(r),console.log(e.cid),{blocks:r,roots:[e.cid]}})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.write=function(r,t,o){try{return Promise.resolve(b(function(){e.existsSync("./cars")||e.mkdirSync("./cars");const{writer:n,out:i}=P.create(r);l.from(i).pipe(e.createWriteStream(`cars/${o}.car`));const s=x(t,function(e){return Promise.resolve(n.put(e)).then(function(){return Promise.resolve(n.close()).then(function(){})})});return s&&s.then?s.then(function(){return i}):i},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.read=function(r){try{const t={[m.code]:m,[d.code]:d,[v.code]:v},o={[h.code]:h};return Promise.resolve(b(function(){const n=e.createReadStream(`./cars/${r}.car`);return Promise.resolve(a.fromIterable(n)).then(function(e){return Promise.resolve(e.getRoots()).then(function(r){function n(){return{blockCid:u,data:c}}const i=[];let c,u;const a=function(e,r,t){if("function"==typeof e[O]){var o=new j,n=e[O]();return n.next().then(s).then(void 0,c),o;function i(e){if(t&&t())return w(o,1,n.return?n.return().then(function(){return e}):e);n.next().then(s).then(void 0,c)}function s(e){e.done?w(o,1):Promise.resolve(r(e.value)).then(i).then(void 0,c)}function c(e){w(o,2,n.return?n.return().then(function(){return e}):e)}}return Promise.resolve(x(e,function(e){return Promise.resolve(e).then(r)},t))}(e.blocks(),function(e){let{cid:r,bytes:n}=e;return Promise.resolve(f.create({cid:r,bytes:n,codec:t[r.code],hasher:o[r.multihash.code]})).then(function(e){i.push(e);const t=e.value instanceof Uint8Array?s.utf8Decoder.decode(e.value):e.value,o=JSON.parse(JSON.stringify(t.data));c=o,u=r.toString(),console.log(`Previous Block CID: ${o.previousBlockCid}, New Block CID: ${r.toString()}`)})});return a&&a.then?a.then(n):n()})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.updatPreviousBlockCid=(e,r)=>{let t=e;return t.previousBlockCid=r,t},this.updateCar1=function(e,r){try{function t(){return console.log(`Car Packed at: cars/${r}.car , CID: ${o}`),o}let o;const n=b(function(){return Promise.resolve(i.read(r)).then(function(t){let{blockCid:n}=t;const s=i.updatPreviousBlockCid(e,n);return Promise.resolve(i.createBlock(s)).then(function(e){let{blocks:t,roots:n}=e;return Promise.resolve(i.write(n,t,r)).then(function(){return Promise.resolve(i.uploadCarToIPFS(r)).then(function(e){o=e})})})})},function(e){console.log(e)});return Promise.resolve(n&&n.then?n.then(t):t())}catch(s){return Promise.reject(s)}},this.writeCar=function(r,t){try{let o;const i=b(function(){return Promise.resolve(n.createBlock(r)).then(function(r){let{blocks:i,roots:s}=r;return Promise.resolve(n.write(s,i,t)).then(function(){return Promise.resolve(n.uploadCarToIPFS(t)).then(function(r){o=r,console.log(`Car Packed at: cars/${t}.car`),e.existsSync(`./cars/${t}.car`)&&e.unlinkSync(`./cars/${t}.car`)})})})},function(e){console.log(e)});return Promise.resolve(i&&i.then?i.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},this.buff2Hex=e=>"0x"+e.toString("hex"),this.getMerkelTree=function(e){try{try{const r=e.map(e=>y(e)),t=new g(r,y),n=o.buff2Hex(t.getRoot());return Promise.resolve({tree:t,root:n})}catch(e){console.log(e)}return Promise.resolve()}catch(e){return Promise.reject(e)}},this.getleave=e=>this.buff2Hex(y(e)),this.getMerkelProof=function(e,r){try{return Promise.resolve(b(function(){return Promise.resolve(t.getMerkelTree(r)).then(function(r){let{tree:o}=r;return o.getProof(e).map(e=>t.buff2Hex(e.data))})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}},this.createProof=function(e,t){try{return Promise.resolve(b(function(){return Promise.resolve(r.read(t)).then(function(t){let{...o}=t;const n=r.getleave(e);return Promise.resolve(r.getMerkelProof(n,o.data.verifiers)).then(function(e){return console.log(e),e})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}}}readCid(e){try{return Promise.resolve(this.invoke(`storage/readData/${e}`))}catch(e){return Promise.reject(e)}}readCarData(e){try{return Promise.resolve(this.invoke(`storage/createCar/${e}`))}catch(e){return Promise.reject(e)}}createCar(e,r){try{return Promise.resolve(this.invoke(`storage/createCar/${r}`,{method:"POST",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}uploadCar(e){try{return Promise.resolve(this.invoke(`storage/uploadCar/${e}`,{method:"POST"}))}catch(e){return Promise.reject(e)}}updateCar(e,r){try{return Promise.resolve(this.invoke(`storage/createCar/${r}`,{method:"PUT",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}getMerkelProof(e,r){try{return Promise.resolve(this.invoke(`storage/getMerkelProof/${e}/${r}`,{method:"GET"}))}catch(e){return Promise.reject(e)}}}function A(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}class T extends ${constructor(){super(...arguments),this.rootFromPath="../circuit",this.rootToPath="sdk/circuit/root.zok"}randomNumber(e){try{let r=[];for(let t=0;t<4;t++){const t=i(e,{entropy:!0});r.push(Math.abs(t.int32()).toString())}return Promise.resolve(r)}catch(e){return Promise.reject(e)}}getNullifier(e){try{const r=i(e,{entropy:!1});return Promise.resolve(Math.abs(r.int32()))}catch(e){return Promise.reject(e)}}fileSystemResolver(e,n){try{const i=t(o(t(e)),n),s=r(i).toString();return Promise.resolve(s)}catch(e){return Promise.reject(e)}}getSource(e,r){try{return Promise.resolve(this.fileSystemResolver(e,r))}catch(e){return Promise.reject(e)}}getZokrateProvider(){try{return Promise.resolve(n())}catch(e){return Promise.reject(e)}}getArtifacts(e){try{return Promise.resolve(this.getZokrateProvider()).then(function(r){return r.compile(e)})}catch(e){return Promise.reject(e)}}getPreImage(e){try{const r=this;return Promise.resolve(A(function(){return Promise.resolve(r.getZokrateProvider()).then(function(t){return Promise.resolve(r.getSource("../circuit","sdk/circuit/preImage.zok")).then(function(o){return Promise.resolve(r.getArtifacts(o)).then(function(r){const{output:o}=t.computeWitness(r,e);return JSON.parse(o)})})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}}generateZkProof(e){try{const r=this;return Promise.resolve(A(function(){return Promise.resolve(r.randomNumber(e)).then(function(e){return Promise.resolve(r.getZokrateProvider()).then(function(t){return Promise.resolve(r.getSource(r.rootFromPath,r.rootToPath)).then(function(o){return Promise.resolve(r.getArtifacts(o)).then(function(o){return Promise.resolve(r.getPreImage(e)).then(function(r){const n=[...e,...r],{witness:i}=t.computeWitness(o,n),s=t.setup(o.program),c=t.generateProof(o.program,i,s.pk),u=s.vk;return{message:"ok",details:{proofBuffer:JSON.stringify(c),verifierKeyBuffer:JSON.stringify(u)}}})})})})})},function(e){return console.log(e),{message:e}}))}catch(e){return Promise.reject(e)}}verifyZkProof(e){try{const r=this,t=e.verifierKeyBuffer,o=JSON.parse(e.proofBuffer),n=JSON.parse(t);return Promise.resolve(A(function(){return Promise.resolve(r.getZokrateProvider()).then(function(e){const r=e.verify(n,o);return r?{message:"Ok",isVerified:r}:{message:"invalid Proof Provided",isVerified:r}})},function(e){return console.log(e),{message:e}}))}catch(e){return Promise.reject(e)}}verifyZkProof1(e){try{return Promise.resolve(this.invoke("zk/verifyProof",{method:"POST",body:JSON.stringify(e)}))}catch(e){return Promise.reject(e)}}}const I=[],N=[];function B(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}class E extends T{createTraceAgreement(e,r){try{const t=this;return Promise.resolve(B(function(){return Promise.resolve(t.getProvider()).then(function(o){const n=new s.Contract(t.getFactoryAddress(),I,r);let i=[];return Promise.resolve(n.newTraceAgreement(e,{gasLimit:21e3,maxFeePerGas:o.getGasPrice(),maxPriorityFeePerGas:o.getGasPrice()})).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1!=e.status)throw new Error("Creation Failed");for(let r of e.events)i.push(r.event);return Promise.resolve(e.events[0].args.agreementAddress).then(function(r){return Promise.resolve(e.events[0].args.id).then(function(t){return{message:"ok",transactionHash:e.hash,details:{agreementAddress:r,agreementId:t}}})})})})})},function(e){return console.log(e),{message:e}}))}catch(e){return Promise.reject(e)}}initilizeAgreement(e,r,t){try{const o=this;return Promise.resolve(B(function(){return Promise.resolve(o.getProvider()).then(function(n){const i=new s.Contract(r,N,t);return Promise.resolve(o.getVerifiersDetails(e)).then(function(e){const r=e.details;return Promise.resolve(i.initilize(r.verifiersRoot,r.nullifiers,r.argumentUri,{gasLimit:21e3,maxFeePerGas:n.getGasPrice(),maxPriorityFeePerGas:n.getGasPrice()})).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1!=e.status)throw new Error("initilization failed");return{message:"ok",transactionHash:e.hash}})})})})},function(e){return console.log(e),{message:e}}))}catch(e){return Promise.reject(e)}}getVerifiersDetails(e){try{const r=this;return Promise.resolve(B(function(){const t=s.utils.defaultAbiCoder;return Promise.resolve(r.getProvider()).then(function(o){return Promise.resolve(r.getMerkelTree(e)).then(function(n){let{root:i}=n;const s=Math.round((new Date).getTime()/1e3).toString();return{message:"ok",details:{verifiersRoot:i,nullifiers:e.forEach(e=>{const n=r.getNullifier(e)*o.getBlockNumber()+s;y(t.encode(["uint"],[n]))}),argumentUri:""}}})})},function(e){console.log(e)}))}catch(e){return Promise.reject(e)}}verifyByOrder(e,r,t,o){try{const n=this;return Promise.resolve(B(function(){return Promise.resolve(n.getProvider()).then(function(n){const i=new s.Contract(e,N,o);let c=[];return Promise.resolve(i.verifyByOrder(r,t,{gasLimit:21e4,maxFeePerGas:n.getGasPrice(),maxPriorityFeePerGas:n.getGasPrice()})).then(function(e){return Promise.resolve(e.wait()).then(function(e){if(1!=e.status)throw new Error("verification failed");for(let r of e.events)c.push(r.event);return Promise.resolve(e.events[0].args.signCount).then(function(r){return Promise.resolve(e.events[0].args.verified).then(function(e){return{message:"ok",details:{verifiedCount:r,verified:e}}})})})})})},function(e){return console.log(e),{message:e}}))}catch(e){return Promise.reject(e)}}}class F extends E{}var D;D=F,[E].forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(r=>{Object.defineProperty(D.prototype,r,Object.getOwnPropertyDescriptor(e.prototype,r)||Object.create(null))})});export{F as default};
